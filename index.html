<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>L√ºscher WebApp</title>
  <!-- SDK Telegram WebApp (–≤ Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç; –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–º–µ—à–∞–µ—Ç) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0c10;--panel:#121318;--text:#e7e9ee;--muted:#a7adbb;--accent:#7c4dff;--primary:#4c8bf5;
      --radius:16px;--shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100%;display:grid;grid-template-rows:auto 1fr auto}
    header,footer{background:linear-gradient(180deg,rgba(18,19,24,.95),rgba(18,19,24,.75));backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
    footer{border-top:1px solid rgba(255,255,255,.06);border-bottom:none}
    .container{max-width:900px;margin:0 auto;padding:16px 20px}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;color:var(--text);background:#1a1c23;border:1px solid rgba(255,255,255,.08)}
    .btn.primary{background:linear-gradient(180deg,#3f7ff3,#346fe0);box-shadow:0 4px 16px rgba(76,139,245,.35)}
    .hero{padding:28px 20px;text-align:center}
    .hero h1{margin:8px 0 6px;font-size:22px}
    .rules{max-width:680px;margin:16px auto 0;text-align:left;background:#101218;border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:12px}
    .stage{display:none}.stage.active{display:block}
    .phase{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#1c2030;border:1px solid rgba(255,255,255,.08);color:#c7d2fe}
    .progress{height:8px;background:#0f1220;border:1px solid rgba(255,255,255,.06);border-radius:999px;overflow:hidden;width:100%}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,#7c4dff,#4c8bf5);transition:width .25s ease}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;padding:16px}
    @media (max-width:560px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .tile{height:84px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);position:relative;cursor:pointer;border:1px solid rgba(255,255,255,.06);transition:transform .12s}
    .tile:hover{transform:translateY(-2px)}
    .label{position:absolute;bottom:8px;left:10px;right:10px;font-weight:700;font-size:13px;color:rgba(255,255,255,.92);text-shadow:0 1px 1px rgba(0,0,0,.35);display:flex;gap:6px;align-items:center}
    .chip{font-size:11px;line-height:1;padding:4px 6px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.18)}
    .muted{color:var(--muted);font-size:13px}
    .finish{padding:18px 16px}
    .grid2{display:grid;grid-template-columns:auto 1fr;gap:6px 12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header><div class="container"><b>–¶–≤–µ—Ç–æ–≤–æ–π —Ç–µ—Å—Ç –õ—é—à–µ—Ä–∞ ‚Äî –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</b></div></header>
    <main><div class="container">
      <!-- –°—Ç–∞—Ä—Ç -->
      <section class="panel hero" id="screen-start">
        <h1>–ì–æ—Ç–æ–≤—ã –∫ –Ω–µ–±–æ–ª—å—à–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É –≤ –¥–≤–∞ –∫—Ä—É–≥–∞?</h1>
        <p class="muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–∞ –ø–æ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–≤–∞–∂–¥—ã. –î–∞–Ω–Ω—ã–µ —É–π–¥—É—Ç –±–æ—Ç—É, –∞ –Ω–∏–∂–µ –≤ –æ–∫–Ω–µ –æ—Ç–æ–±—Ä–∞–∑—è—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</p>
        <div class="rules">
          <b>–ü—Ä–∞–≤–∏–ª–∞ –∫—Ä–∞—Ç–∫–æ</b>
          <ul>
            <li>–†–µ—à–∞–π—Ç–µ –±—ã—Å—Ç—Ä–æ, –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ.</li>
            <li><b>–ö—Ä—É–≥ 1</b>: –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ 8 —Ü–≤–µ—Ç–æ–≤ –æ—Ç ¬´–Ω—Ä–∞–≤–∏—Ç—Å—è¬ª –∫ ¬´–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è¬ª.</li>
            <li><b>–ö—Ä—É–≥ 2</b>: –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—ã–±–æ—Ä –µ—â—ë —Ä–∞–∑.</li>
          </ul>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
          <button class="btn primary" id="btn-start">–ù–∞—á–∞—Ç—å</button>
          <button class="btn" id="btn-demo">–î–µ–º–æ</button>
        </div>
      </section>

      <!-- –í—ã–±–æ—Ä -->
      <section class="panel stage" id="screen-grid">
        <div class="phase">
          <span class="badge" id="badge-phase">–ö—Ä—É–≥ 1</span>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <span class="badge" id="badge-count">0/8</span>
        </div>
        <div class="grid" id="grid"></div>
      </section>

      <!-- –ò—Ç–æ–≥–∏ (–Ω–µ –∑–∞–∫—Ä—ã–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü—É) -->
      <section class="panel stage finish" id="screen-finish">
        <h3 style="margin:0 0 8px">–ì–æ—Ç–æ–≤–æ! –î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã</h3>
        <div id="result"></div>
        <p class="muted" style="margin-top:8px">–í —á–∞—Ç –±–æ—Ç–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ¬´–†–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª ‚Üí ¬´–î–ª—è —Ç–µ–±—è¬ª ‚Üí ¬´–°–∫–∞–∑–∫–∞¬ª.</p>
        <textarea id="out" rows="8" style="width:100%;margin-top:8px;background:#0e1220;color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace"></textarea>
      </section>
    </div></main>
    <footer><div class="container"><span class="muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–º—É Telegram. –°–±—Ä–æ—Å ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</span></div></footer>
  </div>

  <script>
    // --- Telegram WebApp SDK ---
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) { try { tg.ready(); tg.expand(); } catch(e){} }
    function applyTheme(){
      if (!tg) return;
      const th = tg.themeParams||{}, root = document.documentElement.style;
      if (th.bg_color) root.setProperty('--bg', th.bg_color);
      if (th.secondary_bg_color) root.setProperty('--panel', th.secondary_bg_color);
      if (th.text_color) root.setProperty('--text', th.text_color);
      if (th.hint_color) root.setProperty('--muted', th.hint_color);
      if (th.button_color) root.setProperty('--primary', th.button_color);
    }
    applyTheme();

    // --- –ü–∞–ª–∏—Ç—Ä–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
    const COLORS = [
      { id:0, name:'Grey',   emoji:'ü©∂', hex:'#9aa0a6' },
      { id:1, name:'Blue',   emoji:'üîµ', hex:'#1a73e8' },
      { id:2, name:'Green',  emoji:'üü¢', hex:'#34a853' },
      { id:3, name:'Red',    emoji:'üî¥', hex:'#ea4335' },
      { id:4, name:'Yellow', emoji:'üü°', hex:'#fbbc04' },
      { id:5, name:'Violet', emoji:'üü£', hex:'#8e24aa' },
      { id:6, name:'Brown',  emoji:'üü§', hex:'#8d6e63' },
      { id:7, name:'Black',  emoji:'‚ö´', hex:'#202124' },
    ];
    const el = {
      start: document.getElementById('screen-start'),
      grid: document.getElementById('screen-grid'),
      finish: document.getElementById('screen-finish'),
      gridBox: document.getElementById('grid'),
      phaseBadge: document.getElementById('badge-phase'),
      countBadge: document.getElementById('badge-count'),
      bar: document.getElementById('bar'),
      out: document.getElementById('out'),
      result: document.getElementById('result'),
    };
    let phase = 0, pick1 = [], pick2 = [];

    function start(){
      phase = 1; pick1 = []; pick2 = [];
      el.start.style.display = 'none';
      el.grid.classList.add('active');
      renderTiles(remaining());
    }
    function remaining(){
      const arr = (phase===1? pick1 : pick2);
      return COLORS.map(c=>c.id).filter(id => !arr.includes(id));
    }
    function renderTiles(ids){
      el.gridBox.innerHTML = '';
      ids.forEach(id=>{
        const c = COLORS.find(x=>x.id===id);
        const d = document.createElement('div');
        d.className='tile'; d.style.background=c.hex; d.setAttribute('role','button');
        d.onclick=()=>choose(id,d);
        const lab=document.createElement('div'); lab.className='label'; lab.innerHTML=`<span class="chip">${c.emoji}</span> ${c.name}`;
        d.appendChild(lab); el.gridBox.appendChild(d);
      });
      updateProgress();
    }
    function updateProgress(){
      const done = (phase===1? pick1.length : pick2.length);
      el.countBadge.textContent = `${done}/8`;
      el.bar.style.width = `${Math.round(done/8*100)}%`;
      el.phaseBadge.textContent = `–ö—Ä—É–≥ ${phase}`;
    }
    function choose(id,node){
      const arr = (phase===1? pick1 : pick2);
      if (arr.includes(id)) return;
      arr.push(id);
      if (node){ node.style.opacity='.65'; node.style.pointerEvents='none'; }
      updateProgress();
      if (arr.length===8){
        if (phase===1){ phase=2; renderTiles(remaining()); }
        else { finish(); }
      }
    }

    // --- –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è/–≥—Ä—É–ø–ø—ã ---
    function groupOf(pos){ if (pos<=1) return '++'; if (pos<=3) return '+'; if (pos<=5) return 'x'; return '--'; }
    function toPosMap(order){ const m={}; order.forEach((id,i)=>m[id]=i); return m; }
    function score(p2){
      const pos = toPosMap(p2), groups = {'++':[], '+':[], 'x':[], '--':[]};
      COLORS.forEach(c => groups[groupOf(pos[c.id])].push(c.name));
      const hi = [];
      if (groups['++'].includes('Black') || groups['++'].includes('Grey')) hi.push('–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏—é/–≥—Ä–∞–Ω–∏—Ü—ã/—Ä–∞–∑—Ä—ã–≤.');
      if (groups['++'].includes('Blue'))   hi.push('–°–∏–ª—å–Ω–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∏ –ø–æ–∫–æ–µ.');
      if (groups['++'].includes('Red'))    hi.push('–ò–º–ø—É–ª—å—Å –∫ –¥–µ–π—Å—Ç–≤–∏—é –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.');
      if (groups['++'].includes('Yellow')) hi.push('–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –Ω–∞–¥–µ–∂–¥–µ –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ.');
      if (groups['--'].includes('Blue'))   hi.push('–û—Ç–≤–µ—Ä–∂–µ–Ω–∏–µ —Ç–µ–ø–ª–∞ ‚Üí —Ä–∏—Å–∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏.');
      if (groups['--'].includes('Green'))  hi.push('–û—â—É—â–µ–Ω–∏–µ —Å–Ω–∏–∂–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—è/—Å–∞–º–æ—É–≤–∞–∂–µ–Ω–∏—è.');
      return { positions: pos, groups, highlights: hi };
    }

    function finish(){
      const payload = { type:'luscher', version:'1.0.0', ts:Date.now(), pick1, pick2, result: score(pick2) };
      // 1) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–æ—Ç–∞ (n8n –ø–æ–π–º–∞–µ—Ç web_app_data)
      if (tg){ try { tg.sendData(JSON.stringify(payload)); } catch(e){ console.warn('sendData error', e); } }
      // 2) –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü—É
      el.grid.classList.remove('active');
      el.finish.classList.add('active');
      const g = payload.result.groups;
      el.result.innerHTML =
        `<div class="grid2">
          <div><b>++</b></div><div>${(g['++']||[]).join(', ')||'‚Äî'}</div>
          <div><b>+</b></div><div>${(g['+']||[]).join(', ')||'‚Äî'}</div>
          <div><b>x</b></div><div>${(g['x']||[]).join(', ')||'‚Äî'}</div>
          <div><b>--</b></div><div>${(g['--']||[]).join(', ')||'‚Äî'}</div>
        </div>
        ${payload.result.highlights.length ? `<p class="muted" style="margin-top:8px">–ê–∫—Ü–µ–Ω—Ç—ã: ${payload.result.highlights.join(' ')}</p>` : ''}`;
      el.out.value = JSON.stringify(payload, null, 2);
    }

    // --- –ö–Ω–æ–ø–∫–∏ ---
    document.getElementById('btn-start').onclick = start;
    document.getElementById('btn-demo').onclick = ()=>{
      const ids = COLORS.map(c=>c.id);
      pick1 = ids.slice().sort(()=>Math.random()-.5);
      pick2 = ids.slice().sort(()=>Math.random()-.5);
      phase = 2; finish();
    };
  </script>
</body>
</html>
