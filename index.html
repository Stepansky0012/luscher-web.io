<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
  <title>L√ºscher Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      /* –¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ (Calm Dark) */
      --bg: #0f1115;
      --surface: #181a20;
      --primary: #5b8bf7;
      --text: #e1e3e6;
      --muted: #8b92a0;
      --border: rgba(255, 255, 255, 0.08);
      --radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª, –≤—Å—ë –≤–ª–µ–∑–∞–µ—Ç –≤ —ç–∫—Ä–∞–Ω */
    }

    /* --- Header & Top Info --- */
    .top-bar {
      padding: 16px 20px;
      text-align: center;
      background: rgba(15, 17, 21, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    .status-text {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .progress-track {
      height: 4px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      max-width: 300px;
      margin: 0 auto;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* --- Main Grid --- */
    .main-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* Desktop: 4 cols */
      gap: 12px;
      width: 100%;
      max-width: 600px;
      transition: opacity 0.3s;
    }

    @media (max-width: 500px) {
      .color-grid {
        grid-template-columns: repeat(2, 1fr); /* Mobile: 2 cols */
        gap: 10px;
      }
    }

    /* --- Tiles (UI Design) --- */
    .tile {
      aspect-ratio: 1.3;
      border-radius: var(--radius);
      cursor: pointer;
      position: relative;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
    .tile:active { transform: scale(0.95); }
    
    /* –°–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞–Ω–æ" */
    .tile.picked {
      opacity: 0;
      transform: scale(0.8);
      pointer-events: none;
    }

    .tile-icon {
      font-size: 24px;
      opacity: 0; /* –°–∫—Ä—ã—Ç–æ, –ø–æ–∫–∞ –Ω–µ –Ω–∞–≤–µ–¥–µ–Ω–æ –∏–ª–∏ –¥–ª—è –¥–µ–∫–æ—Ä–∞ */
      transition: opacity 0.2s;
    }
    
    /* --- Modal (Rules) --- */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 1;
      transition: opacity 0.3s;
    }

    .modal-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .modal-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      max-width: 340px;
      text-align: center;
      box-shadow: var(--shadow);
      transform: translateY(0);
      transition: transform 0.3s;
    }

    .modal-overlay.hidden .modal-card {
      transform: translateY(20px);
    }

    h2 { margin: 0 0 12px; font-size: 20px; color: var(--text); }
    p { margin: 0 0 20px; font-size: 15px; color: var(--muted); line-height: 1.5; }

    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 14px 0;
      width: 100%;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(91, 139, 247, 0.3);
    }
    .btn:active { transform: scale(0.98); }

    /* --- Loading/Processing State --- */
    .loader {
      display: none;
      text-align: center;
    }
    .spinner {
      width: 30px; height: 30px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ -->
  <div class="modal-overlay" id="modal">
    <div class="modal-card">
      <h2>üß† –¶–≤–µ—Ç–æ–≤–æ–π —Ç–µ—Å—Ç</h2>
      <p>
        –ú—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º <b>—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫—É—é —Å–∫–∞–∑–∫—É</b> —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å.
        <br><br>
        1. –í—ã–±–∏—Ä–∞–π—Ç–µ —Ü–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—è—Ç–Ω—ã <b>–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</b>.
        <br>
        2. –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ—Ç –≤ <b>2 —ç—Ç–∞–ø–∞</b>.
      </p>
      <button class="btn" onclick="closeModal()">–ù–∞—á–∞—Ç—å</button>
    </div>
  </div>

  <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <header class="top-bar">
    <div class="status-text" id="instruction">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∞–º—ã–π –ø—Ä–∏—è—Ç–Ω—ã–π —Ü–≤–µ—Ç</div>
    <div class="progress-track">
      <div class="progress-fill" id="progress"></div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ —Ü–≤–µ—Ç–æ–≤ -->
  <div class="main-container">
    <div class="color-grid" id="grid">
      <!-- –ü–ª–∏—Ç–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JS -->
    </div>
    
    <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ) -->
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <div style="color: var(--muted); font-size: 14px;">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Å–∏—Ö–æ—Ç–∏–ø...<br>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—à—É —Å–∫–∞–∑–∫—É</div>
    </div>
  </div>

  <script>
    // --- Telegram WebApp ---
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
      // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–º—É Telegram (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#0f1115');
    }

    // --- –î–∞–Ω–Ω—ã–µ (–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –õ—é—à–µ—Ä–∞) ---
    const COLORS = [
      { id: 0, hex: '#787878', name: 'Grey' },
      { id: 1, hex: '#004c99', name: 'Blue' },
      { id: 2, hex: '#008f39', name: 'Green' },
      { id: 3, hex: '#ff3333', name: 'Red' },
      { id: 4, hex: '#ffcc00', name: 'Yellow' },
      { id: 5, hex: '#993399', name: 'Violet' },
      { id: 6, hex: '#8b4513', name: 'Brown' },
      { id: 7, hex: '#1a1a1a', name: 'Black' }
    ];

    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    let phase = 1; // 1 –∏–ª–∏ 2
    let picks = {
      round1: [],
      round2: []
    };

    // --- DOM –≠–ª–µ–º–µ–Ω—Ç—ã ---
    const el = {
      modal: document.getElementById('modal'),
      grid: document.getElementById('grid'),
      instruction: document.getElementById('instruction'),
      progress: document.getElementById('progress'),
      loader: document.getElementById('loader')
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    function init() {
      renderGrid();
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    window.closeModal = function() {
      el.modal.classList.add('hidden');
    }

    // –†–µ–Ω–¥–µ—Ä —Å–µ—Ç–∫–∏
    function renderGrid() {
      el.grid.innerHTML = '';
      COLORS.forEach(color => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.style.backgroundColor = color.hex;
        tile.dataset.id = color.id;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        tile.onclick = () => handlePick(color.id, tile);
        
        el.grid.appendChild(tile);
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
    function handlePick(id, tileElement) {
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ –∫–∞–∫–æ–π –º–∞—Å—Å–∏–≤ –ø–∏—Å–∞—Ç—å
      const currentRound = phase === 1 ? picks.round1 : picks.round2;
      
      // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∫–ª–∏–∫–∞
      if (currentRound.includes(id)) return;

      // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä
      currentRound.push(id);
      
      // UI –≠—Ñ—Ñ–µ–∫—Ç: —Å–∫—Ä—ã–≤–∞–µ–º –ø–ª–∏—Ç–∫—É
      tileElement.classList.add('picked');

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä (–≤—Å–µ–≥–æ 16 –∫–ª–∏–∫–æ–≤: 8 –≤ –ø–µ—Ä–≤–æ–º –∫—Ä—É–≥–µ + 8 –≤–æ –≤—Ç–æ—Ä–æ–º)
      const totalPicks = picks.round1.length + picks.round2.length;
      const progressPercent = (totalPicks / 16) * 100;
      el.progress.style.width = `${progressPercent}%`;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫—Ä—É–≥–∞
      if (currentRound.length === 8) {
        if (phase === 1) {
          startRoundTwo();
        } else {
          finishTest();
        }
      }
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫–æ –≤—Ç–æ—Ä–æ–º—É –∫—Ä—É–≥—É
    function startRoundTwo() {
      phase = 2;
      
      setTimeout(() => {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–∏—Ç–æ–∫
        const tiles = document.querySelectorAll('.tile');
        tiles.forEach(t => {
          t.classList.remove('picked');
        });
        
        // –ú–µ–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        el.instruction.style.opacity = 0;
        setTimeout(() => {
          el.instruction.innerText = "–í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø: –≤—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–∞ –µ—â–µ —Ä–∞–∑";
          el.instruction.style.opacity = 1;
        }, 300);
        
      }, 400); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function finishTest() {
      // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ—Ç–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
      el.grid.style.display = 'none';
      el.instruction.innerText = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";
      el.loader.style.display = 'block';

      // –§–æ—Ä–º–∏—Ä—É–µ–º payload –¢–û–ß–ù–û –ö–ê–ö –†–ê–ù–¨–®–ï –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å n8n
      const payload = {
        type: 'luscher_full', // –ú–µ—Ç–∫–∞ –¥–ª—è –±–æ—Ç–∞
        timestamp: Date.now(),
        pick1: picks.round1, // –ú–∞—Å—Å–∏–≤ ID [3, 1, 5...]
        pick2: picks.round2  // –ú–∞—Å—Å–∏–≤ ID
        // –ú—ã –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å–∫–∞–∑–∫–∏ –æ—Ç—Å—é–¥–∞. 
        // –í–µ–±-–∞–ø–ø —Ç–æ–ª—å–∫–æ —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, n8n –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç.
      };

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
      setTimeout(() => {
        if (tg) {
          try {
            tg.sendData(JSON.stringify(payload));
          } catch (e) {
            console.error("Error sending data", e);
            alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram.");
          }
        } else {
          console.log("Telegram WebApp not found. Payload:", payload);
          alert("–î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã! (–í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è)");
        }
      }, 1000); // –ò–º–∏—Ç–∞—Ü–∏—è –¥—É–º–∫–∏ 1 —Å–µ–∫
    }

    // –ó–∞–ø—É—Å–∫
    init();

  </script>
</body>
</html>
